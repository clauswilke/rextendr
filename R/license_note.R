#' Generate LICENSE.note file.
#'
#' LICENSE.note generated by this function contains information about all
#' recursive dependencies in Rust crate.
#'
#' @param path character scalar, the R package directory
#' @param echo logical scalar, whether to print cargo command and outputs to the
#' console (default is `TRUE`)
#' @param quiet logical scalar, whether to signal successful writing of
#' LICENSE.note (default is `FALSE`)
#' @param overwrite logical scalar, whether to regenerate LICENSE.note if
#' LICENSE.note already exists (default is `TRUE`)
#'
#' @return No return value, called for side effects.
#'
#' @export
#'
#' @examples
#' \dontrun{
#' write_license_note()
#' }
write_license_note <- function(
    path = ".",
    echo = TRUE,
    quiet = FALSE,
    overwrite = TRUE) {
  check_string(path, class = "rextendr_error")
  check_bool(echo, class = "rextendr_error")
  check_bool(quiet, class = "rextendr_error")
  check_bool(overwrite, class = "rextendr_error")

  rust_folder <- rprojroot::find_package_root_file(
    "src", "rust",
    path = path
  )

  outfile <- rprojroot::find_package_root_file(
    "LICENSE.note",
    path = path
  )

  packages <- read_cargo_metadata(
    path = path,
    dependencies = TRUE
  )[["packages"]]

  .prep_authors <- function(authors, package) {
    authors <- ifelse(
      is.na(authors),
      paste0(package, " authors"),
      authors
    )

    authors <- stringi::stri_replace_all_regex(authors, r"(\ <.+?>)", "")

    stringi::stri_replace_all_regex(authors, r"(\|)", ", ")
  }

  packages[["authors"]] <- lapply(
    packages[["authors"]],
    function(x) .prep_authors(x, packages[["name"]])
  )

  separator <- "-------------------------------------------------------------"

  note_header <- glue::glue(
    "
    The binary compiled from the source code of this package \\
    contains the following Rust crates:


    {separator}
    "
  )

  note_body <- glue::glue_data(
    packages,
    "

    Name:        {name}
    Repository:  {repository}
    Authors:     {authors}
    License:     {license}

    {separator}
    "
  )

  write_file(
    text = c(note_header, note_body),
    path = outfile,
    search_root_from = path,
    quiet = quiet,
    overwrite = overwrite
  )
}
