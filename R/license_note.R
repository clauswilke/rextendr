#' Generate LICENSE.note file.
#'
#' LICENSE.note generated by this function contains information about all
#' recursive dependencies in Rust crate.
#'
#' @param path character scalar, the R package directory
#' @param echo logical scalar, whether to print cargo command and outputs to the
#' console (default is `TRUE`)
#' @param quiet logical scalar, whether to signal successful writing of
#' LICENSE.note (default is `FALSE`)
#' @param overwrite logical scalar, whether to regenerate LICENSE.note if
#' LICENSE.note already exists (default is `TRUE`)
#'
#' @return No return value, called for side effects.
#'
#' @export
#'
#' @examples
#' \dontrun{
#' write_license_note()
#' }
write_license_note <- function(
    path = ".",
    echo = TRUE,
    quiet = FALSE,
    overwrite = TRUE) {
  check_string(path, class = "rextendr_error")
  check_bool(echo, class = "rextendr_error")
  check_bool(quiet, class = "rextendr_error")
  check_bool(overwrite, class = "rextendr_error")

  rust_folder <- rprojroot::find_package_root_file(
    "src", "rust",
    path = path
  )

  outfile <- rprojroot::find_package_root_file(
    "LICENSE.note",
    path = path
  )

  metadata <- read_cargo_metadata(
    path = path,
    dependencies = TRUE
  )

  packages <- metadata[["packages"]]

  # exclude current package from LICENSE.note
  current_package <- metadata[["resolve"]][["root"]]

  packages <- packages[packages[["id"]] != current_package, ]

  replace_na <- function(data, replace = NA, ...) {
    if (vctrs::vec_any_missing(data)) {
      missing <- vctrs::vec_detect_missing(data)
      data <- vctrs::vec_assign(data, missing, replace,
        x_arg = "data",
        value_arg = "replace"
      )
    }
    data
  }

  packages[["respository"]] <- replace_na(
    packages[["repository"]],
    "unknown"
  )

  packages[["licenses"]] <- replace_na(
    packages[["repository"]],
    "not provided"
  )

  prep_authors <- function(authors, package) {
    authors <- ifelse(
      is.na(authors),
      paste0(package, " authors"),
      authors
    )

    authors <- stringi::stri_replace_all_regex(authors, r"(\ <.+?>)", "")

    paste0(authors, collapse = ", ")
  }

  packages[["authors"]] <- unlist(Map(
    prep_authors,
    packages[["authors"]],
    packages[["name"]]
  ))

  separator <- "-------------------------------------------------------------"

  note_header <- glue::glue(
    "
    The binary compiled from the source code of this package \\
    contains the following Rust crates:


    {separator}
    "
  )

  note_body <- glue::glue_data(
    packages,
    "

    Name:        {name}
    Repository:  {repository}
    Authors:     {authors}
    License:     {license}

    {separator}
    "
  )

  write_file(
    text = c(note_header, note_body),
    path = outfile,
    search_root_from = path,
    quiet = quiet,
    overwrite = overwrite
  )
}
